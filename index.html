<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Spring Security - D√©codage et d√©mystification üïµÔ∏è</title>

		<meta name="description" content="...">
		<meta name="author" content="Daniel Garnier-Moiroux">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/white.css" id="theme">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="plugin/highlight/vs.css">

    <style>
      .reveal pre {
        width: 100%;
      }

      .reveal :not(pre)>code {
        /* TODO */
        color: red;
      }

      :root {
        --r-heading-text-transform: none;
      }
    </style>
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
        <section data-markdown>
          <script type="text/template">
            ## Spring Security - D√©codage et d√©mystification üïµÔ∏è

            <img src="images/profile_picture.jpeg" height="200px" style="border-radius: 50%;">

            Devoxx FR - 2022/04/20

            Daniel Garnier-Moiroux

            ---

            ## Daniel Garnier-Moiroux

            <img src="images/profile_picture.jpeg" height="200px" style="border-radius: 50%;">

            Software Engineer @ VMware (Spring Commercial)

            https://garnier.wf/

            https://github.com/Kehrlann

            @Kehrlann



            
            Notes:
            C'est moi! Trouvez moi sur internet.

            Je bosse chez VMware, dans les √©quipes Spring Commercial.

            Je contribue √† Spring Security.

            Aussi, prof d'informatique pour les √©l√®ves de 1ere ann√© en √©cole d'ing√©.

            ---

            ## Plan

            1. D√©mo de base <!-- .element: class="fragment highlight-blue" -->
            2. Th√©orie
                1. Authentication - "domain language"
                2. Filter - "bloc de base HTTP"
                3. AuthenticationProviders - "authentifier"
                4. Configurers - "naviguer dans spring-security"
            

            Notes:

            On va parler de beaucoup de choses, c'est tr√®s dense.

            Le but de la pr√©sentation, c'est que vous puissiez naviguer seuls dans spring-security

            ---

            ## Demo

            Follow-along:

            https://github.com/Kehrlann/spring-security-workshop-code

            Notes:

            - start.spring.io
            - gradle
            - java 11 
            - Boot 2.6.x
            - web + devtools
            - NOT security yet

            ---
            
            **HelloWorldController.java**

            ```java
            @RestController
            public class HelloWorldController {

              @GetMapping("/")
              public String publicPage() {
                return "Hello World!";
              }

              @GetMapping("private")
              public String privatePage() {
                return "Mmmmh, this should be private ü§î";
              }

            }
            ```

            Notes:

            - Spring Boot classique, une page publique + une priv√©e
            - Montrer dans le browser

            ---

            **build.gradle**

            ```gradle [4]
            dependencies {
              implementation 'org.springframework.boot:spring-boot-starter-web'
              implementation 'org.springframework.boot:spring-boot-devtools'
              implementation 'org.springframework.boot:spring-boot-starter-security'
              testImplementation 'org.springframework.boot:spring-boot-starter-test'
            }
            ```

            Notes:

            - Ajouter Spring Security
            - Montrer dans le browser
            - Montrer les logs
            - Montrer SecurityAutoConfiguration

            ---

            **SecurityConfig.java**

            ```java
            @Configuration
            @EnableWebSecurity
            public class SecurityConfig {

              @Bean
              SecurityFilterChain securityFilterChain(HttpSecurity http) 
                  throws Exception {
                return http.authorizeRequests()
                      .antMatchers("/").permitAll()
                      .antMatchers("/error").permitAll() // error page
                      .anyRequest().authenticated()
                    .and().build();
              }
            }
            ```

            Notes:

            - SecurityFilterChain
            - D'abord "/private" .authenticated()
            - Puis le pattern "correct"
            - Notez: on ne peut pas se logguer!

            ---

            **SecurityConfig.java**

            ```java [10]
            public class SecurityConfig {

              @Bean
              SecurityFilterChain securityFilterChain(HttpSecurity http) 
                  throws Exception {
                return http.authorizeRequests()
                      .antMatchers("/").permitAll()
                      .antMatchers("/error").permitAll() // error page
                      .anyRequest().authenticated()
                    .and().formLogin()
                    .and().build();
              }
            }
            ```

            Notes:

            - Ca r√©active le form login de Spring Security
            - Toujours mot de passe auto-g√©n√©r√©

            ---

            **SecurityConfig.java**

            ```java [13-14]
            @Configuration
            @EnableWebSecurity
            public class SecurityConfig {
              // [...]
              @Bean
              UserDetailsService userDetailsService() {
                return new InMemoryUserDetailsManager(
                    new User("user", "{noop}password", Collections.emptyList())
                );
              }
            }
            ```

            Notes:

            - On peut cr√©er des @Beans qui font des choses
            - On trouve √ßa dans la doc/les guides
            - CF la doc?
            - On peut aussi ajouter d'autres modules de Spring Security

            ---

            **build.gradle**

            ```gradle [5]
            dependencies {
              implementation 'org.springframework.boot:spring-boot-starter-web'
              implementation 'org.springframework.boot:spring-boot-devtools'
              implementation 'org.springframework.boot:spring-boot-starter-security'
              implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'
              testImplementation 'org.springframework.boot:spring-boot-starter-test'
            }
            ```

            Notes:

            - Login oauth2/open id
            - Est-ce que vous √™tes familiers avec OAuth2? 
            - On ne va pas parler du protocole en particulier
            - Mais le combo boot + security permet de juste changer la config
            - Et activer un nouveau type de login
            
            ---

            **SecurityConfig.java**

            ```java [10]
            public class SecurityConfig {

              @Bean
              SecurityFilterChain securityFilterChain(HttpSecurity http) 
                  throws Exception {
                return http.authorizeRequests()
                      .antMatchers("/").permitAll()
                      .antMatchers("/error").permitAll() // error page
                      .anyRequest().authenticated()
                    .and().oauth2Login()
                    .and().build();
              }
            }
            ```

            Notes:

            - Activer le nouveau type de login

            ---

            **application.yml**

            ```yaml
            spring:
             security:
              oauth2:
               client:
                 registration:
                   google: # magic name, [google|facebook|github]
                    client-id: "PLACEHOLDER"
                    client-secret: "PLACEHOLDER"
            ``` 

            Notes:

            - Ajouter google via console.cloud.google.com
            - Search Api Keys, Add new OAuth2 Login
            - redirect url: 

            `http://localhost:8080/login/oauth2/code/google`

            - Configurer le client-id/secret
            - Login: tadaa!

            ---

            **HelloWorldController.java**

            ```java [3-8]
            public class HelloWorldController {

              @GetMapping("private")
              public String privatePage(Authentication authentication) {
                return "Welcome to this very private page, ~[" 
                    + getName(authentication)
                    + "]~! ü•≥üéâüçæ";
              }

              private String getName(Authentication authentication) {
                // ...
              }
            }
            ```

            Notes:

            - On peut injecter l'authentication
            - Et afficher le nom

            ---

            **HelloWorldController.java**

            ```java
            public class HelloWorldController {

              private String getName(Authentication authentication) {
                return Optional.of(authentication)
                  .filter(OAuth2AuthenticationToken.class::isInstance)
                  .map(OAuth2AuthenticationToken.class::cast)
                  .map(OAuth2AuthenticationToken::getPrincipal)
                  .map(OidcUser.class::cast)
                  .map(StandardClaimAccessor::getEmail)
                  .orElseGet(authentication::getName);
              }
            }
            ```

            Notes:

            - maintenant le nom c'est un peu moche via google
            - c'est un guid dans le cadre de ce serveur
            - on peut extraire l'e-mail mais c'est touchy...

            ---

            ## Alors?

            C'est compliqu√©, n'est-ce pas? <!-- .element: class="fragment" -->
            
            Notes:

            - Compliqu√© n'est-ce pas?

            ---

            ## Plan

            1. D√©mo de base
            2. Th√©orie
                1. Authentication - "domain language" <!-- .element: class="fragment highlight-blue" -->
                2. Filter - "bloc de base HTTP"
                3. AuthenticationProviders - "authentifier"
                4. Configurers - "naviguer dans spring-security"

            Notes:

            - Le but de la d√©mo ce n'est pas que vous sachiez reproduire
            - Ni m√™me que vous reteniez
            - Juste montrer que c'est compliqu√©
            - Et donner une base de discussion

            ---

            ## C√¥t√© "consommateur"

            Spring Security produit des `Authentication`. Celles-ci sont utilis√©es pour:
            - Authentification (`authn`): _qui_ est le user?
            - Authorization (`authz`): est-ce que le user _√† le droit de faire_ XYZ?

            ---

            ## Un peu de vocabulaire

            - **Authentication**: repr√©sente l'utilisateur. Contient:
              - **Principal**: "identit√©" de l'utilsateur (nom, email...)
              - **GrantedAuthorities**: "permissions" (`roles`, ...)

            Plus de d√©tails: https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html

            Notes:

            - Authentication: ce que Spring Sec produit, repr√©sente une entit√© authentifi√©e
            - Principal: "qui" est identifi√©, c'est ce qui vous int√©resse le plus
              - e.g. nom, adresse mail, client_id, etc.
            - GrantedAuthorities
              - souvent la forme "ROLE_admin"
              - un simple wrapper autour d'une String
              - On ne verra pas tous les d√©tails ajd, se concentre sur l'identit√©

            ---

            ## Un peu de vocabulaire (cont')

            - **Authentication** contient aussi:
              - **.isAuthenticated()**: presque toujours `true`
              - **details**: infos suppl√©mentaires sur la _requ√™te_
              - (Credentials): "password", souvent mis √† `null`
            
            Plus de d√©tails: https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html

            Notes:

            - Moins int√©ressant
              - isAuthenticated: true, sinon la requ√™te peut √™tre rejet√©e
            - Montrer classe authentication
            - Notez que Principal est un `Object`
              - grand th√®me de la flexibilit√© spring-security

            ---

            ## Et du coup

            ```java
            @Override
            public boolean supports(final Class<?> authentication) {
              return (UsernamePasswordAuthenticationToken.class.isAssignableFrom(authentication))
                  || (CasAuthenticationToken.class.isAssignableFrom(authentication))
                  || (CasAssertionAuthenticationToken.class.isAssignableFrom(authentication));
            }
            ```


            Notes:

            - Du coup ce n'est pas la lib la plus type-safe du monde
            - Mais √ßa permet de s'interfacer avec le monde entier, future-proof

            ---

            ## Maximum confusion

            ```java [|2|6]
            public interface Authentication 
              extends Principal,
              Serializable {

              // [...]
              Object getPrincipal();
            }
            ```

            Notes:

            - extends Principal: java.security.Principal
            - Je vous encourage √† travailler exclusivement avec des objets Spring Security
              - Don't: public String foo(Principal principal)
              - Do: foo(Authentication auth)
            - getPrincipal: `Object` comme √ßa super extensible
              - Tr√®s, tr√®s, tr√®s confusant
              - Exemple: UserDetails dans UsernamePasswordAuthenticationToken
              - Comment trouver? Debugger le plus simple.
              - Montrer.
            
            ---

            ## Pour vos applis

            - **DO**:
              - Cr√©er vos propres sous-classes `Authentication`
            - **DON'T**:
              - Utiliser `UsernamePasswordAuthenticationToken` partout 

            Notes:

            - M√™me dans les tests! TestingAuthenticationToken, etc

            ---

            ## Le tout dans un SecurityContext

            - Thread-local, non propag√© pass√© aux threads enfants
            - Nettoy√© quand la requ√™te est trait√©e √† 100%

            Notes:

            - Montrer SecurityContextHolder.getSecurityContext().getAuthentication()
              - Pratique si vous ne voulez pas cascader
            - Montrer new Thread(...).start()
            - Pratique si nest√©!
              - Montrer un FooService
              - Montrer @PreAuthorize()

            ---

            ## R√©capitulatif

            <img src="images/securitycontextholder.png" height="200px">

            Notes:

            - Simple pour l'utilisation
            - SecurityContextHolder -> SecurityContext
            - Objet qui nous int√©resse, une Authentication
              - Avec un Principal (identit√©) et GrantedAuthorities ("permissions")

            ---



          </script>
        </section>

    </div>

    <script src="dist/reveal.js"></script>
    <script src="plugin/zoom/zoom.js"></script>
    <script src="plugin/notes/notes.js"></script>
    <script src="plugin/search/search.js"></script>
    <script src="plugin/markdown/markdown.js"></script>
    <script src="plugin/highlight/highlight.js"></script>
    <script>

			// Also available as an ES module, see:
			// https://revealjs.com/initialization/
			Reveal.initialize({
				controls: true,
				progress: true,
				center: true,
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealZoom, RevealNotes, RevealSearch, RevealMarkdown, RevealHighlight ]
			});

		</script>
    <script src="socket.io/socket.io.js"></script>
    <script src="node_modules/reveal-notes-server/client.js"></script>

	</body>
</html>
